# Hello Events Installer

These scripts provision the structures and data needed for the Hello Events solution to work on a site.

For an introduction about the PnP Provisioning Engine see [PnP remote provisioning](https://docs.microsoft.com/en-us/sharepoint/dev/solution-guidance/pnp-remote-provisioning).

## Prerequisites

* Install the [PnP ProwerShell](https://docs.microsoft.com/en-us/powershell/sharepoint/sharepoint-pnp/sharepoint-pnp-cmdlets?view=sharepoint-ps#installation)

For example, this would install the PnP PowerShell for SharePoint Online:

```PowerShell
Install-Module SharePointPnPPowerShellOnline
```

The PnP PowerShell is needed because the installer uses a few commands directly from it and because the PnP Provisioning Engine is also available from the PnP PowerShell.

* Organise an user which is site collection administrator in order to connect to SharePoint. It could be a tenant administrator for development. The credentials will be requested by the installer scripts.

## Applying the Provisioning Template

In short, execute the PowerShell script [`set-template.ps1`](./set-template.ps1) to apply the templates to the given site.

For details see the scripts, template files and data files here and the other sections within this document.

## Creating the Provisioning Template

The site columns, site content types and lists are defined in a provisioning template. This template can be generated based on the structures of a given site and saved on a file for later use.

The script [`save-template.ps1`](./save-template.ps1) generates this template file.

Template file: [`hello-events-template.xml`](./hello-events-template.xml)

Note: as the template file is already part of the installer there is no need to execute this script everytime again.

### Content Types for the Template

It is possible to specify the content type groups of the content types to be imported to the template. See the parameter `ContentTypeGroups` for that, ex.:

```PowerShell
Get-PnPProvisioningTemplate -Out $TemplateFilePath -ContentTypeGroups "_Hello Events"
```

### Data Initialization

The default data like list items and files are added in a separeted step to the template, see [`save-template.ps1`](./save-template.ps1) for details.

* Files are referenced by `pnp:File` elements that are generated by the PnP command `Add-PnPFileToProvisioningTemplate`

* List items are stored in `pnp:DataRows` elements that are generated by the PnP command `Add-PnPDataRowsToProvisioningTemplate`.
  * Add the attribute `KeyColumn` to the template with the column to be used in the matching with existing items so that these same items are not created everytime the template is applied. Ex.: `<pnp:DataRows KeyColumn="Title" UpdateBehavior="Overwrite">`
  * It is possible to define the default data in a separeted template file, if desired. This makes easier to apply a custom logic bout if the items should be initialized or not, for example. See the template file [`events-data.xml`](./events-data.xml)

* Files from folders can be also imported using `pnp:Directory` elements, see details about this element below.

## Template Preparation

The saved template is a base for the provisioning, but it has to be manually updated as described below.

### Template Cleanup

After saving the template to a file the out of the box site columns (`Field` elements) and lists (`pnp:ListInstance` elements) should be manually removed from the template file.

Anything else that is not specific to your customization should be questioned if it should remain in the template.

### Removing Default Content Types from the Lists

The default content types, as for example Item, can be removed from the list instances specified on the template. If this is not done, these content types are created along with the lists, despite the fact that they are not specified in the template.

For that, it is required to add the content type to the template with attribute `Remove="true"`. Ex., to remove Item:

```Xml
<pnp:ContentTypeBinding ContentTypeID="0x01" Remove="true"/>
```

### Uploading Files from a Local Folder

It is possible to upload files from a local folder to a library or folder on SharePoint.

Use the `pnp:Directory` for that.

#### Setting Metadata for the Files

The metadata of the files can be set as per a JSON file specified in the attribute `MetadataMappingFile`.

Metadata file example: [`event-images-metadata.json`](./event-images-metadata.json)

The path separator used in the `Src` attribute has to be the same as in the Metadata file (with character escaping), otherwise the mapping does not work. 

Ex., `pnp:Directory` in template and Metadata file - note the paths using backslash (\\):

```Xml
<pnp:Directory Src=".\event-images" Folder="EventContentImages" Overwrite="true"
    Recursive="false" MetadataMappingFile=".\event-images-metadata.json" />
```

```JSON
{".\\event-images\\team-event.png":{"Title":"Team Event"}}
```

#### Avoiding Multiple Creation of the same Items

See the attribute `KeyColumn` as described above.

### Setting the Type of Note Fields

Review if Note fields should be `Compatible` or `FullHTML` in attribute `RichTextMode`.

## Further Reading

* [PnP-Provisioning-Schema](https://github.com/SharePoint/PnP-Provisioning-Schema/): examples and template schema definition
* [PnP remote provisioning](https://docs.microsoft.com/en-us/sharepoint/dev/solution-guidance/pnp-remote-provisioning).